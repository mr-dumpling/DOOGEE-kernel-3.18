/* t591_dg_a57_bd_we -  */
#include <linux/string.h>
#include "lcm_drv.h"

#define FRAME_WIDTH  (720)
#define FRAME_HEIGHT (1280)

#define UDELAY(n) (lcm_util.udelay(n))
#define MDELAY(n) (lcm_util.mdelay(n))

#define SET_RESET_PIN(v)    (lcm_util.set_reset_pin((v)))
#define dsi_set_cmdq_V2(cmd, count, ppara, force_update)	        lcm_util.dsi_set_cmdq_V2(cmd, count, ppara, force_update)
#define dsi_set_cmdq(pdata, queue_size, force_update)		lcm_util.dsi_set_cmdq(pdata, queue_size, force_update)
#define wrtie_cmd(cmd)										lcm_util.dsi_write_cmd(cmd)
#define write_regs(addr, pdata, byte_nums)					lcm_util.dsi_write_regs(addr, pdata, byte_nums)
#define read_reg(cmd)											lcm_util.dsi_dcs_read_lcm_reg(cmd)
#define read_reg_v2(cmd, buffer, buffer_size)   				lcm_util.dsi_dcs_read_lcm_reg_v2(cmd, buffer, buffer_size)   

#define   LCM_DSI_CMD_MODE							0


static LCM_UTIL_FUNCS lcm_util = {0};

struct LCM_setting_table {
    unsigned cmd;
    unsigned char count;
    unsigned char para_list[64];
};


// NT355211 on 0x104BF6C
#define REGFLAG_DELAY                                       0XFE
#define REGFLAG_END_OF_TABLE                                0xFF   // END OF REGISTERS MARKER
static struct LCM_setting_table lcm_initialization_setting[] =
{
	{0xff, 4, {0xaa,0x55,0x25,0x01}},
	{0xfc, 1, {0x08}},
	{0xfc, 1, {0x00}},
	{0x6f, 1, {0x21}},
	{0xf7, 1, {0x01}},
	{0x6f, 1, {0x21}},
	{0xf7, 1, {0x00}},
	{0x6f, 1, {0x1a}},
	{0xf7, 1, {0x05}},
	{0x6f, 1, {0x16}},
	{0xf7, 1, {0x10}},
	{0xff, 4, {0xaa,0x55,0x25,0x00}},
	{0xf0, 5, {0x55,0xaa,0x52,0x08,0x00}},
	{0xb1, 2, {0x68,0x27}},
	{0xb8, 4, {0x01,0x02,0x0c,0x02}},
	{0xbb, 2, {0x11,0x11}},
	{0xbc, 2, {0x00,0x00}},
	{0xb6, 1, {0x04}},
	{0xc8, 1, {0x80}},
	{0xf0, 5, {0x55,0xaa,0x52,0x08,0x01}},
	{0xb0, 2, {0x09,0x09}},
	{0xb1, 2, {0x09,0x09}},
	{0xbc, 2, {0x7b,0x00}},
	{0xbd, 2, {0x7b,0x00}},
	{0xca, 1, {0x00}},
	{0xc0, 1, {0x0c}},
	{0xb5, 2, {0x03,0x03}},
	{0xbe, 1, {0x38}},
	{0xb3, 2, {0x19,0x19}},
	{0xb4, 2, {0x19,0x19}},
	{0xb9, 2, {0x26,0x26}},
	{0xba, 2, {0x36,0x36}},
	{0xf0, 5, {0x55,0xaa,0x52,0x08,0x02}},
	{0xee, 1, {0x01}},
	{0xb0, 16, {0x00,0x00,0x00,0x0a,0x00,0x1d,0x00,0x2f,0x00,0x3e,0x00,0x5c,0x00,0x76,0x00,0xa2}},
	{0xb1, 16, {0x00,0xc6,0x01,0x04,0x01,0x36,0x01,0x85,0x01,0xc7,0x01,0xc8,0x02,0x03,0x02,0x46}},
	{0xb2, 16, {0x02,0x71,0x02,0xae,0x02,0xd8,0x03,0x11,0x03,0x37,0x03,0x68,0x03,0x89,0x03,0xb0}},
	{0xb3, 4, {0x03,0xdd,0x03,0xff}},
	{0xf0, 5, {0x55,0xaa,0x52,0x08,0x06}},
	{0xb0, 2, {0x10,0x12}},
	{0xb1, 2, {0x14,0x16}},
	{0xb2, 2, {0x00,0x02}},
	{0xb3, 2, {0x31,0x31}},
	{0xb4, 2, {0x31,0x34}},
	{0xb5, 2, {0x34,0x34}},
	{0xb6, 2, {0x34,0x31}},
	{0xb7, 2, {0x31,0x31}},
	{0xb8, 2, {0x31,0x31}},
	{0xb9, 2, {0x2d,0x2e}},
	{0xba, 2, {0x2e,0x2d}},
	{0xbb, 2, {0x31,0x31}},
	{0xbc, 2, {0x31,0x31}},
	{0xbd, 2, {0x31,0x34}},
	{0xbe, 2, {0x34,0x34}},
	{0xbf, 2, {0x34,0x31}},
	{0xc0, 2, {0x31,0x31}},
	{0xc1, 2, {0x03,0x01}},
	{0xc2, 2, {0x17,0x15}},
	{0xc3, 2, {0x13,0x11}},
	{0xe5, 2, {0x31,0x31}},
	{0xc4, 2, {0x17,0x15}},
	{0xc5, 2, {0x13,0x11}},
	{0xc6, 2, {0x03,0x01}},
	{0xc7, 2, {0x31,0x31}},
	{0xc8, 2, {0x31,0x34}},
	{0xc9, 2, {0x34,0x34}},
	{0xca, 2, {0x34,0x31}},
	{0xcb, 2, {0x31,0x31}},
	{0xcc, 2, {0x31,0x31}},
	{0xcd, 2, {0x2e,0x2d}},
	{0xce, 2, {0x2d,0x2e}},
	{0xcf, 2, {0x31,0x31}},
	{0xd0, 2, {0x31,0x31}},
	{0xd1, 2, {0x31,0x34}},
	{0xd2, 2, {0x34,0x34}},
	{0xd3, 2, {0x34,0x31}},
	{0xd4, 2, {0x31,0x31}},
	{0xd5, 2, {0x00,0x02}},
	{0xd6, 2, {0x10,0x12}},
	{0xd7, 2, {0x14,0x16}},
	{0xe6, 2, {0x32,0x32}},
	{0xd8, 5, {0x00,0x00,0x00,0x00,0x00}},
	{0xd9, 5, {0x00,0x00,0x00,0x00,0x00}},
	{0xe7, 1, {0x00}},
	{0xf0, 5, {0x55,0xaa,0x52,0x08,0x05}},
	{0xed, 1, {0x30}},
	{0xb0, 2, {0x17,0x06}},
	{0xb8, 1, {0x00}},
	{0xc0, 1, {0x0d}},
	{0xc1, 1, {0x0b}},
	{0xc2, 1, {0x23}},
	{0xc3, 1, {0x40}},
	{0xc4, 1, {0x84}},
	{0xc5, 1, {0x82}},
	{0xc6, 1, {0x82}},
	{0xc7, 1, {0x80}},
	{0xc8, 2, {0x0b,0x30}},
	{0xc9, 2, {0x05,0x10}},
	{0xca, 2, {0x01,0x10}},
	{0xcb, 2, {0x01,0x10}},
	{0xd1, 5, {0x03,0x05,0x05,0x07,0x00}},
	{0xd2, 5, {0x03,0x05,0x09,0x03,0x00}},
	{0xd3, 5, {0x00,0x00,0x6a,0x07,0x10}},
	{0xd4, 5, {0x30,0x00,0x6a,0x07,0x10}},
	{0xf0, 5, {0x55,0xaa,0x52,0x08,0x03}},
	{0xb0, 2, {0x00,0x00}},
	{0xb1, 2, {0x00,0x00}},
	{0xb2, 5, {0x05,0x00,0x0a,0x00,0x00}},
	{0xb3, 5, {0x05,0x00,0x0a,0x00,0x00}},
	{0xb4, 5, {0x05,0x00,0x0a,0x00,0x00}},
	{0xb5, 5, {0x05,0x00,0x0a,0x00,0x00}},
	{0xb6, 5, {0x02,0x00,0x0a,0x00,0x00}},
	{0xb7, 5, {0x02,0x00,0x0a,0x00,0x00}},
	{0xb8, 5, {0x02,0x00,0x0a,0x00,0x00}},
	{0xb9, 5, {0x02,0x00,0x0a,0x00,0x00}},
	{0xba, 5, {0x53,0x00,0x0a,0x00,0x00}},
	{0xbb, 5, {0x53,0x00,0x0a,0x00,0x00}},
	{0xbc, 5, {0x53,0x00,0x0a,0x00,0x00}},
	{0xbd, 5, {0x53,0x00,0x0a,0x00,0x00}},
	{0xc4, 1, {0x60}},
	{0xc5, 1, {0x40}},
	{0xc6, 1, {0x64}},
	{0xc7, 1, {0x44}},
	{0x11, 0, {0x00,0x00}},
	{REGFLAG_DELAY, 120, {}}, //0xfe?
	{0x29, 0, {0x00,0x00}},
	{REGFLAG_DELAY, 10, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
	{REGFLAG_END_OF_TABLE, 0x00, {}}  //Stop cmd is 0xff

};


static void push_table(struct LCM_setting_table *table, unsigned int count, unsigned char force_update)
{
	    unsigned int i;
	
	    for(i = 0; i < count; i++)
	    {
	
	        unsigned cmd;
	        cmd = table[i].cmd;
	
	        switch (cmd)
	        {
	            case REGFLAG_DELAY :
	                MDELAY(table[i].count);
	                break;
	            case REGFLAG_END_OF_TABLE :
	                break;
	            default:
					//dsi_send_cmdq_tinno(cmd, table[i].count, table[i].para_list, force_update);
					dsi_set_cmdq_V2(cmd, table[i].count, table[i].para_list, force_update);
	        }
	    }

}

static void lcm_set_util_funcs(const LCM_UTIL_FUNCS *util)
{
	    memcpy(&lcm_util, util, sizeof(LCM_UTIL_FUNCS));
}


static void lcm_get_params(LCM_PARAMS *params)
{

	memset(params, 0, sizeof(LCM_PARAMS));

	params->type   = 2;

	params->width  = FRAME_WIDTH;
	params->height = FRAME_HEIGHT;

	// enable tearing-free
	params->dbi.te_mode = 1;
	params->dbi.te_edge_polarity = 0;

	params->dsi.mode = 1;

	// DSI
	/* Command mode setting */
	//1 Three lane or Four lane
//	params->dsi.LANE_NUM				= LCM_THREE_LANE;
	params->dsi.LANE_NUM				= LCM_FOUR_LANE;
	//The following defined the fomat for data coming from LCD engine.
	params->dsi.data_format.color_order = LCM_COLOR_ORDER_RGB;
	params->dsi.data_format.trans_seq   = LCM_DSI_TRANS_SEQ_MSB_FIRST;
	params->dsi.data_format.padding     = LCM_DSI_PADDING_ON_LSB;
	params->dsi.data_format.format      = LCM_DSI_FORMAT_RGB888;

	// Highly depends on LCD driver capability.
	params->dsi.packet_size=128;

	/** Video mode setting
	 because DSI/DPI HW design change,
	 this parameters should be 0 when video mode in MT658X;
	 or memory leakage */
	params->dsi.intermediat_buffer_num = 0;

	params->dsi.PS=LCM_PACKED_PS_24BIT_RGB888;
	params->dsi.word_count=720*3;	
	params->dsi.compatibility_for_nvk = 1;

	params->dsi.vertical_sync_active				= 4;// 3    2
	params->dsi.vertical_backporch					= 38;// 20   1
	params->dsi.vertical_frontporch					= 40; // 1  12
	params->dsi.vertical_active_line				= FRAME_HEIGHT;

	params->dsi.horizontal_sync_active				= 10;// 50  2
	params->dsi.horizontal_backporch				= 72;
	params->dsi.horizontal_frontporch				= 72 ;
	params->dsi.horizontal_active_pixel				= FRAME_WIDTH;

	// Bit rate calculation
	// 1 Every lane speed
	params->dsi.pll_div1=4;
	params->dsi.pll_div2=12;	
	params->dsi.fbk_div =16;	
}

static void lcm_init(void)
{
	SET_RESET_PIN(1);
	MDELAY(10);
	SET_RESET_PIN(0);
	MDELAY(10);
	SET_RESET_PIN(1);
	MDELAY(120);      
	
	push_table(lcm_initialization_setting, sizeof(lcm_initialization_setting) / sizeof(struct LCM_setting_table), 1);
}

static unsigned int rgk_lcm_compare_id(void)
{
	return 1;
	
}

static void lcm_suspend(void)
{
	unsigned int data_array[16];
	
	// Display Off
	data_array[0] = 0x00280500; 
	dsi_set_cmdq(data_array, 1, 1);
		
	MDELAY(20);
	
	// Sleep In
	data_array[0] = 0x00100500;
	dsi_set_cmdq(data_array, 1, 1);
	   
	MDELAY(120);
	SET_RESET_PIN(0);
	MDELAY(50);

}

static void lcm_resume(void)
{
	lcm_init();
}

LCM_DRIVER nt35521_boe_hd720_5p0_xingliangda_t591_dg = 
{
    	.name		= "nt35521_boe_hd720_5p0_xingliangda_t591_dg",
	.set_util_funcs = lcm_set_util_funcs,
	.get_params     = lcm_get_params,
	.init           = lcm_init,
	.suspend        = lcm_suspend,
	.resume         = lcm_resume,
	.compare_id     = rgk_lcm_compare_id,
};
